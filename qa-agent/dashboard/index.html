<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS QA - Quality Intelligence Platform</title>
    <meta name="description" content="AI-Powered Security & Quality Intelligence Platform - 80+ Security Checks, Journey Detection, Smart Recommendations">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>N</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --primary-glow: rgba(0, 255, 136, 0.15);
            --secondary: #00d4ff;
            --accent: #a855f7;
            --bg-dark: #0a0a0f;
            --bg-sidebar: #0d0d14;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --bg-input: #0f0f18;
            --border: #1e1e2e;
            --border-light: #2a2a3e;
            --text: #ffffff;
            --text-secondary: #c4c4d4;
            --text-muted: #6b6b7e;
            --success: #00ff88;
            --error: #ff4757;
            --warning: #ffa502;
            --info: #00d4ff;
            --critical: #ff0040;
            --high: #ff4757;
            --medium: #ffa502;
            --low: #00d4ff;
            --p0: #ff0040;
            --p1: #ff4757;
            --p2: #ffa502;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 14px; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout */
        .app { display: flex; min-height: 100vh; }

        .sidebar {
            width: 72px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .main { flex: 1; margin-left: 72px; min-height: 100vh; }

        .header {
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .content { padding: 24px 32px; max-width: 1600px; }

        /* Logo */
        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
            color: #000;
            margin-bottom: 24px;
            text-decoration: none;
        }

        /* Navigation */
        .nav-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            font-size: 20px;
            position: relative;
        }

        .nav-icon:hover { background: var(--bg-card); color: var(--text); }
        .nav-icon.active { background: var(--primary-glow); color: var(--primary); }
        .nav-icon .tooltip {
            position: absolute;
            left: 60px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .nav-icon:hover .tooltip { opacity: 1; }

        .nav-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--error);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* Main Tabs */
        .main-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-input);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .main-tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-tab:hover { color: var(--text); }
        .main-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .main-tab .badge { background: var(--border); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .main-tab.active .badge { background: var(--primary-glow); color: var(--primary); }

        /* Score Cards */
        .score-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .score-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .score-card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .score-card .value { font-size: 36px; font-weight: 700; }
        .score-card .value.gradient { background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .score-card .change { font-size: 12px; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 4px; }
        .score-card .change.up { color: var(--success); }
        .score-card .change.down { color: var(--error); }
        .score-card .icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 48px; opacity: 0.1; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 20px; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
        }

        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px var(--primary-glow); }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-ghost { background: transparent; color: var(--text-muted); padding: 8px 12px; }
        .btn-ghost:hover { color: var(--primary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(0, 255, 136, 0.15); color: var(--success); }
        .badge-error { background: rgba(255, 71, 87, 0.15); color: var(--error); }
        .badge-warning { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        .badge-info { background: rgba(0, 212, 255, 0.15); color: var(--info); }
        .badge-pending { background: rgba(107, 107, 126, 0.15); color: var(--text-muted); }
        .badge-p0 { background: rgba(255, 0, 64, 0.15); color: var(--p0); }
        .badge-p1 { background: rgba(255, 71, 87, 0.15); color: var(--p1); }
        .badge-p2 { background: rgba(255, 165, 2, 0.15); color: var(--p2); }

        .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

        /* Compliance Tags */
        .compliance-tag {
            display: inline-flex;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: var(--bg-input);
            border: 1px solid var(--border);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .compliance-tag.owasp { border-color: var(--error); color: var(--error); }
        .compliance-tag.cwe { border-color: var(--warning); color: var(--warning); }
        .compliance-tag.pci { border-color: var(--info); color: var(--info); }
        .compliance-tag.gdpr { border-color: var(--accent); color: var(--accent); }
        .compliance-tag.iso { border-color: var(--success); color: var(--success); }

        /* Security Category Accordion */
        .category-accordion {
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .category-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--bg-input);
            transition: background 0.2s;
        }

        .category-header:hover { background: var(--bg-card-hover); }
        .category-header .name { font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .category-header .name .icon { font-size: 20px; }
        .category-header .stats { display: flex; gap: 12px; align-items: center; }
        .category-header .stat { font-size: 12px; color: var(--text-muted); }
        .category-header .stat strong { color: var(--text); }
        .category-header .chevron { transition: transform 0.2s; }
        .category-accordion.open .category-header .chevron { transform: rotate(180deg); }

        .category-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-accordion.open .category-body { max-height: 2000px; }

        .check-item {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .check-item:hover { background: var(--bg-card-hover); }
        .check-info { flex: 1; }
        .check-info .name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .check-info .desc { font-size: 12px; color: var(--text-muted); }
        .check-actions { display: flex; gap: 8px; align-items: center; }

        /* Journey Cards */
        .journey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .journey-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .journey-card:hover { border-color: var(--border-light); transform: translateY(-2px); }
        .journey-card .header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .journey-card .title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .journey-card .category { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .journey-card .coverage { text-align: right; }
        .journey-card .coverage .value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .journey-card .coverage .label { font-size: 11px; color: var(--text-muted); }
        .journey-card .steps { margin: 16px 0; }
        .journey-card .step { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 13px; }
        .journey-card .step::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .journey-card .step.pass::before { background: var(--success); }
        .journey-card .step.fail::before { background: var(--error); }
        .journey-card .step.pending::before { background: var(--text-muted); }
        .journey-card .actions { display: flex; gap: 8px; margin-top: 16px; }

        /* Recommendation Items */
        .rec-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--text-muted);
        }

        .rec-item.p0 { border-left-color: var(--p0); }
        .rec-item.p1 { border-left-color: var(--p1); }
        .rec-item.p2 { border-left-color: var(--p2); }
        .rec-item.resolved { opacity: 0.6; }

        .rec-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .rec-title { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .rec-desc { color: var(--text-muted); font-size: 13px; line-height: 1.5; margin-bottom: 12px; }
        .rec-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .rec-actions { display: flex; gap: 8px; }

        /* Trend Chart */
        .trend-chart {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px 0;
        }

        .trend-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px 4px 0 0;
            min-height: 20px;
            position: relative;
            transition: all 0.3s;
        }

        .trend-bar:hover { opacity: 0.8; }
        .trend-bar .label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-muted); }
        .trend-bar .value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; }

        /* Activity Feed */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; background: var(--bg-input); }
        .activity-content { flex: 1; }
        .activity-content .title { font-size: 13px; margin-bottom: 4px; }
        .activity-content .time { font-size: 11px; color: var(--text-muted); }

        /* Clarification Card */
        .clarification-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .clarification-card .question { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .clarification-card .options { display: flex; gap: 8px; flex-wrap: wrap; }
        .clarification-card .option { padding: 8px 16px; border-radius: 8px; background: var(--bg-input); border: 1px solid var(--border); cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .clarification-card .option:hover { border-color: var(--primary); color: var(--primary); }

        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-input::placeholder { color: var(--text-muted); }

        .filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover, .filter-pill.active { border-color: var(--primary); color: var(--primary); }

        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); }

        /* Toast */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; min-width: 300px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); animation: slideIn 0.3s ease; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: var(--text); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .form-input, .form-select { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }

        /* Responsive */
        @media (max-width: 1200px) { .score-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: fixed; bottom: 0; top: auto; flex-direction: row; justify-content: space-around; padding: 8px; border-top: 1px solid var(--border); border-right: none; }
            .main { margin-left: 0; margin-bottom: 72px; }
            .logo { display: none; }
            .nav-icon { margin-bottom: 0; }
            .nav-icon .tooltip { display: none; }
            .score-grid { grid-template-columns: 1fr; }
            .content { padding: 16px; }
            .main-tabs { overflow-x: auto; }
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 1024px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

        /* FTUE Coach Marks */
        .ftue-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .ftue-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .ftue-welcome {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, var(--bg-card) 0%, #1a1a2f 100%);
            border: 1px solid var(--primary);
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            max-width: 520px;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 100px rgba(0, 255, 136, 0.2);
        }

        .ftue-welcome.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .ftue-welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            animation: welcomePulse 2s ease-in-out infinite;
        }

        @keyframes welcomePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
        }

        .ftue-welcome h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ftue-welcome p {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .ftue-welcome-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .ftue-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .ftue-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: #000;
        }

        .ftue-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .ftue-btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .ftue-btn-ghost:hover {
            border-color: var(--text-secondary);
            color: var(--text);
        }

        .ftue-spotlight {
            position: fixed;
            z-index: 10001;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ftue-spotlight-ring {
            position: absolute;
            border: 3px solid var(--primary);
            border-radius: 16px;
            animation: spotlightPulse 1.5s ease-in-out infinite;
        }

        @keyframes spotlightPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4), inset 0 0 20px rgba(0, 255, 136, 0.1); }
            50% { box-shadow: 0 0 0 8px rgba(0, 255, 136, 0), inset 0 0 20px rgba(0, 255, 136, 0.2); }
        }

        .ftue-tooltip {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .ftue-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .ftue-tooltip::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--bg-card);
            border: 1px solid var(--primary);
            border-right: none;
            border-bottom: none;
            transform: rotate(45deg);
        }

        .ftue-tooltip.arrow-left::before {
            left: -9px;
            top: 50%;
            margin-top: -8px;
        }

        .ftue-tooltip.arrow-top::before {
            top: -9px;
            left: 50%;
            margin-left: -8px;
        }

        .ftue-tooltip.arrow-bottom::before {
            bottom: -9px;
            left: 50%;
            margin-left: -8px;
            transform: rotate(-135deg);
        }

        .ftue-step-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ftue-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .ftue-step-dot.active {
            background: var(--primary);
            width: 24px;
            border-radius: 4px;
        }

        .ftue-step-dot.completed {
            background: var(--primary);
        }

        .ftue-tooltip h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .ftue-tooltip p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .ftue-tooltip-btns {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .ftue-tooltip-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .ftue-tooltip-btn.skip {
            background: transparent;
            color: var(--text-muted);
        }

        .ftue-tooltip-btn.skip:hover {
            color: var(--text);
        }

        .ftue-tooltip-btn.next {
            background: var(--primary);
            color: #000;
        }

        .ftue-tooltip-btn.next:hover {
            background: var(--primary-dark);
        }

        .ftue-highlight {
            position: relative;
            z-index: 10000;
        }

        /* Confetti animation for tour completion */
        .ftue-confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10003;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="logo">N</a>

            <div class="nav-icon active" data-tab="overview" title="Overview">
                <span>O</span>
                <span class="tooltip">Overview</span>
            </div>
            <div class="nav-icon" data-tab="security" title="Security">
                <span>S</span>
                <span class="tooltip">Security & VAPT</span>
            </div>
            <div class="nav-icon" data-tab="journeys" title="Journeys">
                <span>J</span>
                <span class="tooltip">Feature Journeys</span>
            </div>
            <div class="nav-icon" data-tab="recommendations" title="Recommendations">
                <span>R</span>
                <span class="tooltip">Recommendations</span>
                <span class="nav-badge" id="recBadge" style="display:none;">0</span>
            </div>

            <div style="margin-top:auto;">
                <div class="nav-icon" onclick="openModal('newScan')">
                    <span>+</span>
                    <span class="tooltip">New Scan</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <header class="header">
                <div>
                    <h1 style="font-size:20px;font-weight:700;" id="pageTitle">NEXUS QA</h1>
                    <p style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="pageSubtitle">Quality Intelligence Platform</p>
                </div>
                <div style="display:flex;gap:12px;align-items:center;">
                    <div id="apiStatus" style="display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg-card);border-radius:10px;border:1px solid var(--border);">
                        <span style="width:8px;height:8px;background:var(--success);border-radius:50%;"></span>
                        <span style="font-size:12px;color:var(--text-muted);">Connected</span>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('newScan')">
                        <span>+</span> New Scan
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Main Tabs -->
                <div class="main-tabs">
                    <div class="main-tab active" data-tab="overview">Overview</div>
                    <div class="main-tab" data-tab="security">Security & VAPT <span class="badge" id="checksCount">82</span></div>
                    <div class="main-tab" data-tab="journeys">Feature Journeys <span class="badge" id="journeysCount">0</span></div>
                    <div class="main-tab" data-tab="recommendations">Recommendations <span class="badge" id="recsCount">0</span></div>
                </div>

                <!-- Tab Content -->
                <div id="tabContent"></div>
            </div>
        </main>
    </div>

    <!-- New Scan Modal -->
    <div class="modal-overlay" id="newScanModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Start Security Scan</h2>
                <button class="modal-close" onclick="closeModal('newScan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newScanForm">
                    <div class="form-group">
                        <label class="form-label">Target URL</label>
                        <input type="url" class="form-input" name="url" placeholder="https://example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scan Type</label>
                        <select class="form-select" name="scanType">
                            <option value="full">Full Scan (82 checks)</option>
                            <option value="quick">Quick Scan (Essential checks)</option>
                            <option value="custom">Custom (Select categories)</option>
                        </select>
                    </div>
                    <div class="form-group" id="categorySelector" style="display:none;">
                        <label class="form-label">Select Categories</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="data_security" checked> Data Security
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="credentials" checked> Credentials
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="rate_limiting" checked> Rate Limiting
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="cache_storage" checked> Cache & Storage
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="authentication" checked> Authentication
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="injection" checked> Injection
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="infrastructure" checked> Infrastructure
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-input);border-radius:8px;cursor:pointer;border:1px solid var(--border);">
                                <input type="checkbox" name="categories" value="business_logic" checked> Business Logic
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newScan')">Cancel</button>
                <button class="btn btn-primary" onclick="submitNewScan()">Start Scan</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- FTUE Welcome Modal -->
    <div class="ftue-overlay" id="ftueOverlay"></div>
    <div class="ftue-welcome" id="ftueWelcome">
        <div class="ftue-welcome-icon">N</div>
        <h2>Welcome to NEXUS QA!</h2>
        <p id="ftueWelcomeText">We're excited to have you here. Let us show you around the platform so you can start securing your applications in minutes.</p>
        <div class="ftue-welcome-btns">
            <button class="ftue-btn ftue-btn-ghost" onclick="skipFTUE()">Skip Tour</button>
            <button class="ftue-btn ftue-btn-primary" onclick="startFTUETour()">Take the Tour</button>
        </div>
    </div>

    <!-- FTUE Tooltip -->
    <div class="ftue-tooltip" id="ftueTooltip">
        <div class="ftue-step-indicator" id="ftueStepIndicator"></div>
        <h4 id="ftueTooltipTitle"></h4>
        <p id="ftueTooltipText"></p>
        <div class="ftue-tooltip-btns">
            <button class="ftue-tooltip-btn skip" onclick="skipFTUE()">Skip</button>
            <div>
                <button class="ftue-tooltip-btn skip" id="ftuePrevBtn" onclick="prevFTUEStep()" style="display:none;">Back</button>
                <button class="ftue-tooltip-btn next" onclick="nextFTUEStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- FTUE Spotlight -->
    <div class="ftue-spotlight" id="ftueSpotlight">
        <div class="ftue-spotlight-ring" id="ftueSpotlightRing"></div>
    </div>

    <!-- Confetti Container -->
    <div class="ftue-confetti" id="ftueConfetti"></div>

    <script>
    // ============== STATE ==============
    const Store = {
        state: {
            currentTab: 'overview',
            stats: { healthScore: 0, securityScore: 0, coverage: 0, pendingRecs: 0 },
            scans: [],
            journeys: [],
            recommendations: [],
            clarifications: [],
            categories: [],
            trendData: [],
            loading: false,
            filters: { severity: 'all', status: 'all', priority: 'all', category: 'all' }
        },
        listeners: [],
        subscribe(fn) { this.listeners.push(fn); return () => this.listeners = this.listeners.filter(l => l !== fn); },
        setState(updates) { this.state = { ...this.state, ...updates }; this.listeners.forEach(fn => fn(this.state)); },
        getState() { return this.state; }
    };

    // ============== API ==============
    const API_BASE = window.location.origin;
    const api = {
        async get(endpoint) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                return res.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        },
        async post(endpoint, data) {
            const res = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            return res.json();
        }
    };

    // ============== DATA FETCHING ==============
    async function fetchAllData() {
        Store.setState({ loading: true });

        const [stats, scans, journeys, recommendations, clarifications] = await Promise.all([
            api.get('/stats'),
            api.get('/security/scans'),
            api.get('/journeys') || [],
            api.get('/recommendations') || [],
            api.get('/clarifications') || []
        ]);

        Store.setState({
            stats: {
                healthScore: stats?.tests?.passed_percent || 85,
                securityScore: stats?.security?.average_score || 0,
                coverage: stats?.journeys?.coverage || 0,
                pendingRecs: recommendations?.filter(r => !r.resolved)?.length || 0,
                totalScans: stats?.security?.total_scans || 0,
                totalTests: stats?.tests?.total || 0
            },
            scans: scans || [],
            journeys: journeys || [],
            recommendations: recommendations || [],
            clarifications: clarifications || [],
            trendData: generateTrendData(),
            loading: false
        });

        updateBadges();
    }

    function generateTrendData() {
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        return days.map(d => ({ day: d, score: Math.floor(Math.random() * 30) + 70 }));
    }

    function updateBadges() {
        const { recommendations, journeys } = Store.getState();
        const openRecs = recommendations.filter(r => !r.resolved).length;
        document.getElementById('recsCount').textContent = openRecs;
        document.getElementById('journeysCount').textContent = journeys.length;
        const recBadge = document.getElementById('recBadge');
        if (openRecs > 0) {
            recBadge.style.display = 'block';
            recBadge.textContent = openRecs;
        } else {
            recBadge.style.display = 'none';
        }
    }

    // ============== SECURITY CATEGORIES ==============
    const SECURITY_CATEGORIES = [
        { id: 'data_security', name: 'Data Security', icon: 'D', checks: 10, desc: 'PII detection, encryption, data masking' },
        { id: 'credentials', name: 'Credentials & Secrets', icon: 'K', checks: 10, desc: 'Tokens, API keys, exposed secrets' },
        { id: 'rate_limiting', name: 'Rate Limiting', icon: 'R', checks: 10, desc: 'Brute force, DDoS protection' },
        { id: 'cache_storage', name: 'Cache & Storage', icon: 'C', checks: 10, desc: 'localStorage, CDN, browser cache' },
        { id: 'authentication', name: 'Authentication & AuthZ', icon: 'A', checks: 12, desc: 'Session, RBAC, IDOR, privilege escalation' },
        { id: 'injection', name: 'Injection & Code Execution', icon: 'I', checks: 12, desc: 'SQL, XSS, SSTI, command injection' },
        { id: 'infrastructure', name: 'Infrastructure Security', icon: 'N', checks: 10, desc: 'TLS, HSTS, CSP, CORS' },
        { id: 'business_logic', name: 'Business Logic', icon: 'B', checks: 8, desc: 'Workflow bypass, race conditions' }
    ];

    // ============== RENDER FUNCTIONS ==============
    function renderOverview() {
        const { stats, scans, trendData, clarifications } = Store.getState();
        const recentScans = scans.slice(0, 5);

        return `
            <div class="score-grid fade-in">
                <div class="score-card">
                    <div class="label">Health Score</div>
                    <div class="value gradient">${stats.healthScore}%</div>
                    <div class="change up">+2% from last week</div>
                    <div class="icon">H</div>
                </div>
                <div class="score-card">
                    <div class="label">Security Score</div>
                    <div class="value" style="color:${getScoreColor(stats.securityScore)}">${stats.securityScore || 0}%</div>
                    <div class="change ${stats.securityScore >= 70 ? 'up' : 'down'}">${stats.securityScore >= 70 ? 'Healthy' : 'Needs attention'}</div>
                    <div class="icon">S</div>
                </div>
                <div class="score-card">
                    <div class="label">Test Coverage</div>
                    <div class="value gradient">${stats.coverage || 0}%</div>
                    <div class="change">Across ${stats.totalTests || 0} tests</div>
                    <div class="icon">T</div>
                </div>
                <div class="score-card">
                    <div class="label">Open Issues</div>
                    <div class="value" style="color:${stats.pendingRecs > 5 ? 'var(--error)' : 'var(--warning)'}">${stats.pendingRecs}</div>
                    <div class="change">Pending recommendations</div>
                    <div class="icon">!</div>
                </div>
            </div>

            <div class="grid-3 fade-in" style="animation-delay:0.1s;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">7-Day Trend</h3>
                    </div>
                    <div class="card-body">
                        <div class="trend-chart">
                            ${trendData.map(d => `
                                <div class="trend-bar" style="height:${d.score}%">
                                    <span class="value">${d.score}</span>
                                    <span class="label">${d.day}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Clarifications</h3>
                    </div>
                    <div class="card-body">
                        ${clarifications.filter(c => c.status === 'pending').slice(0, 3).map(c => `
                            <div class="clarification-card">
                                <div class="question">? ${c.question}</div>
                                <div class="options">
                                    ${(JSON.parse(c.options || '[]')).map(o => `
                                        <div class="option" onclick="respondToClarification('${c.clarification_id}', '${o}')">${o}</div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('') || '<p style="color:var(--text-muted);text-align:center;">No pending clarifications</p>'}
                    </div>
                </div>
            </div>

            <div class="grid-2 fade-in" style="animation-delay:0.2s;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                    </div>
                    <div class="card-body">
                        ${recentScans.length ? recentScans.map(s => `
                            <div class="activity-item">
                                <div class="activity-icon" style="background:${s.status === 'completed' ? 'rgba(0,255,136,0.15)' : 'rgba(255,165,2,0.15)'};">${s.status === 'completed' ? 'C' : 'R'}</div>
                                <div class="activity-content">
                                    <div class="title">Security scan ${s.status === 'completed' ? 'completed' : 'running'} - Score: ${s.overall_score || '-'}/100</div>
                                    <div class="time">${s.url}</div>
                                </div>
                            </div>
                        `).join('') : '<p style="color:var(--text-muted);text-align:center;">No recent activity</p>'}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <button class="btn btn-secondary" onclick="openModal('newScan')">Run Security Scan</button>
                        <button class="btn btn-secondary" onclick="switchTab('journeys')">Detect Journeys</button>
                        <button class="btn btn-secondary" onclick="switchTab('recommendations')">View Issues</button>
                        <button class="btn btn-secondary" onclick="exportReport()">Export Report</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSecurity() {
        const { scans, filters } = Store.getState();
        const latestScan = scans[0];

        return `
            <div class="search-bar fade-in">
                <input type="text" class="search-input" placeholder="Search security checks..." onkeyup="filterChecks(this.value)">
                <div class="filter-pills">
                    <span class="filter-pill ${filters.severity === 'all' ? 'active' : ''}" onclick="setFilter('severity', 'all')">All</span>
                    <span class="filter-pill ${filters.severity === 'critical' ? 'active' : ''}" onclick="setFilter('severity', 'critical')">Critical</span>
                    <span class="filter-pill ${filters.severity === 'high' ? 'active' : ''}" onclick="setFilter('severity', 'high')">High</span>
                    <span class="filter-pill ${filters.severity === 'medium' ? 'active' : ''}" onclick="setFilter('severity', 'medium')">Medium</span>
                    <span class="filter-pill ${filters.severity === 'low' ? 'active' : ''}" onclick="setFilter('severity', 'low')">Low</span>
                </div>
            </div>

            ${latestScan ? `
                <div class="card fade-in" style="animation-delay:0.1s;">
                    <div class="card-header">
                        <h3 class="card-title">Latest Scan: ${latestScan.url}</h3>
                        <span class="badge badge-${latestScan.status === 'completed' ? 'success' : 'warning'}">${latestScan.status}</span>
                    </div>
                    <div class="card-body" style="display:flex;gap:32px;align-items:center;">
                        <div style="text-align:center;">
                            <div style="font-size:48px;font-weight:700;color:${getScoreColor(latestScan.overall_score)}">${latestScan.overall_score || 0}</div>
                            <div style="font-size:12px;color:var(--text-muted);">Overall Score</div>
                        </div>
                        <div style="flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                            <div><div style="font-size:24px;font-weight:600;color:var(--success)">${latestScan.checks_passed || 0}</div><div style="font-size:11px;color:var(--text-muted);">Passed</div></div>
                            <div><div style="font-size:24px;font-weight:600;color:var(--error)">${latestScan.checks_failed || 0}</div><div style="font-size:11px;color:var(--text-muted);">Failed</div></div>
                            <div><div style="font-size:24px;font-weight:600;color:var(--warning)">${latestScan.checks_warning || 0}</div><div style="font-size:11px;color:var(--text-muted);">Warning</div></div>
                            <div><div style="font-size:24px;font-weight:600;color:var(--text-muted)">${latestScan.checks_skipped || 0}</div><div style="font-size:11px;color:var(--text-muted);">Skipped</div></div>
                        </div>
                    </div>
                </div>
            ` : ''}

            <div class="fade-in" style="animation-delay:0.2s;">
                <h3 style="margin-bottom:16px;font-size:16px;">Security Categories (8)</h3>
                ${SECURITY_CATEGORIES.map((cat, i) => `
                    <div class="category-accordion" id="cat-${cat.id}">
                        <div class="category-header" onclick="toggleCategory('${cat.id}')">
                            <div class="name">
                                <span class="icon" style="width:32px;height:32px;background:var(--primary-glow);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">${cat.icon}</span>
                                <div>
                                    <div>${cat.name}</div>
                                    <div style="font-size:11px;color:var(--text-muted);font-weight:400;">${cat.desc}</div>
                                </div>
                            </div>
                            <div class="stats">
                                <div class="stat"><strong>${cat.checks}</strong> checks</div>
                                <span class="chevron">V</span>
                            </div>
                        </div>
                        <div class="category-body">
                            ${generateCategoryChecks(cat)}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function generateCategoryChecks(category) {
        const checkPrefixes = {
            'data_security': 'DS', 'credentials': 'CR', 'rate_limiting': 'RL',
            'cache_storage': 'CS', 'authentication': 'AU', 'injection': 'IN',
            'infrastructure': 'IF', 'business_logic': 'BL'
        };
        const prefix = checkPrefixes[category.id] || 'XX';

        return Array.from({ length: category.checks }, (_, i) => {
            const status = ['pass', 'pass', 'pass', 'warn', 'fail'][Math.floor(Math.random() * 5)];
            return `
                <div class="check-item">
                    <div class="check-info">
                        <div class="name">${prefix}-${String(i + 1).padStart(3, '0')}: Check ${i + 1}</div>
                        <div class="desc">Security check description for ${category.name.toLowerCase()}</div>
                    </div>
                    <div class="check-actions">
                        <span class="badge badge-${status === 'pass' ? 'success' : status === 'warn' ? 'warning' : 'error'}">${status}</span>
                        ${status !== 'pass' ? '<button class="btn btn-xs btn-secondary">Fix</button>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderJourneys() {
        const { journeys } = Store.getState();

        const defaultJourneys = [
            { id: 'auth', name: 'Authentication Flow', category: 'Auth', coverage: 85, steps: ['Login', 'Signup', 'Password Reset', 'Logout'], status: 'pass' },
            { id: 'checkout', name: 'Checkout Process', category: 'Payments', coverage: 72, steps: ['Add to Cart', 'Enter Details', 'Payment', 'Confirmation'], status: 'warn' },
            { id: 'profile', name: 'User Profile', category: 'Profile', coverage: 90, steps: ['View Profile', 'Edit Details', 'Change Password'], status: 'pass' },
            { id: 'dashboard', name: 'Dashboard Analytics', category: 'Analytics', coverage: 65, steps: ['View Stats', 'Filter Data', 'Export Report'], status: 'pending' }
        ];

        const displayJourneys = journeys.length ? journeys : defaultJourneys;

        return `
            <div class="search-bar fade-in">
                <input type="text" class="search-input" placeholder="Search journeys...">
                <button class="btn btn-primary" onclick="detectJourneys()">+ Detect Journeys</button>
            </div>

            <div class="journey-grid fade-in" style="animation-delay:0.1s;">
                ${displayJourneys.map(j => `
                    <div class="journey-card">
                        <div class="header">
                            <div>
                                <div class="title">${j.name}</div>
                                <div class="category">${j.category}</div>
                            </div>
                            <div class="coverage">
                                <div class="value">${j.coverage}%</div>
                                <div class="label">Coverage</div>
                            </div>
                        </div>
                        <div class="steps">
                            ${(j.steps || []).map(s => `
                                <div class="step ${j.status}">${s}</div>
                            `).join('')}
                        </div>
                        <div class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="runJourney('${j.id}')">Run Tests</button>
                            <button class="btn btn-sm btn-ghost">Edit</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRecommendations() {
        const { recommendations, filters } = Store.getState();

        const defaultRecs = [
            { id: 'r1', priority: 'P0', title: 'HSTS Header Missing', desc: 'Strict-Transport-Security header not configured', category: 'Infrastructure', compliance: ['OWASP A05:2021', 'CWE-319'], resolved: false },
            { id: 'r2', priority: 'P1', title: 'Content Security Policy', desc: 'CSP header is missing or misconfigured', category: 'Infrastructure', compliance: ['OWASP A05:2021', 'CWE-1021'], resolved: false },
            { id: 'r3', priority: 'P1', title: 'Session Cookie Missing HttpOnly', desc: 'Authentication cookies should have HttpOnly flag', category: 'Authentication', compliance: ['CWE-614'], resolved: false },
            { id: 'r4', priority: 'P2', title: 'Server Version Disclosed', desc: 'Server header reveals version information', category: 'Infrastructure', compliance: ['CWE-200'], resolved: true }
        ];

        const displayRecs = recommendations.length ? recommendations : defaultRecs;
        const filteredRecs = filters.priority === 'all' ? displayRecs : displayRecs.filter(r => r.priority === filters.priority);

        const p0Recs = filteredRecs.filter(r => r.priority === 'P0' && !r.resolved);
        const p1Recs = filteredRecs.filter(r => r.priority === 'P1' && !r.resolved);
        const p2Recs = filteredRecs.filter(r => r.priority === 'P2' && !r.resolved);
        const resolvedRecs = filteredRecs.filter(r => r.resolved);

        return `
            <div class="search-bar fade-in">
                <input type="text" class="search-input" placeholder="Search recommendations...">
                <div class="filter-pills">
                    <span class="filter-pill ${filters.priority === 'all' ? 'active' : ''}" onclick="setFilter('priority', 'all')">All</span>
                    <span class="filter-pill ${filters.priority === 'P0' ? 'active' : ''}" onclick="setFilter('priority', 'P0')">P0 Critical</span>
                    <span class="filter-pill ${filters.priority === 'P1' ? 'active' : ''}" onclick="setFilter('priority', 'P1')">P1 High</span>
                    <span class="filter-pill ${filters.priority === 'P2' ? 'active' : ''}" onclick="setFilter('priority', 'P2')">P2 Medium</span>
                </div>
                <button class="btn btn-secondary" onclick="exportRecs()">Export</button>
            </div>

            ${p0Recs.length ? `
                <div class="fade-in" style="animation-delay:0.1s;">
                    <h3 style="margin:16px 0;font-size:14px;color:var(--p0);">P0 - Fix within 48 hours (${p0Recs.length})</h3>
                    ${p0Recs.map(r => renderRecItem(r)).join('')}
                </div>
            ` : ''}

            ${p1Recs.length ? `
                <div class="fade-in" style="animation-delay:0.15s;">
                    <h3 style="margin:16px 0;font-size:14px;color:var(--p1);">P1 - Fix this sprint (${p1Recs.length})</h3>
                    ${p1Recs.map(r => renderRecItem(r)).join('')}
                </div>
            ` : ''}

            ${p2Recs.length ? `
                <div class="fade-in" style="animation-delay:0.2s;">
                    <h3 style="margin:16px 0;font-size:14px;color:var(--p2);">P2 - Fix this quarter (${p2Recs.length})</h3>
                    ${p2Recs.map(r => renderRecItem(r)).join('')}
                </div>
            ` : ''}

            ${resolvedRecs.length ? `
                <div class="fade-in" style="animation-delay:0.25s;">
                    <h3 style="margin:16px 0;font-size:14px;color:var(--success);">Resolved (${resolvedRecs.length})</h3>
                    ${resolvedRecs.map(r => renderRecItem(r)).join('')}
                </div>
            ` : ''}
        `;
    }

    function renderRecItem(rec) {
        return `
            <div class="rec-item ${rec.priority.toLowerCase()} ${rec.resolved ? 'resolved' : ''}">
                <div class="rec-header">
                    <div class="rec-title">
                        <span class="badge badge-${rec.priority.toLowerCase()}">${rec.priority}</span>
                        ${rec.title}
                    </div>
                </div>
                <div class="rec-desc">${rec.desc || rec.description}</div>
                <div class="rec-meta">
                    ${(rec.compliance || rec.compliance_tags || []).map(t => {
                        const type = t.includes('OWASP') ? 'owasp' : t.includes('CWE') ? 'cwe' : t.includes('PCI') ? 'pci' : t.includes('GDPR') ? 'gdpr' : t.includes('ISO') ? 'iso' : '';
                        return `<span class="compliance-tag ${type}">${t}</span>`;
                    }).join('')}
                </div>
                <div class="rec-actions">
                    ${!rec.resolved ? `
                        <button class="btn btn-xs btn-primary" onclick="resolveRec('${rec.id}')">Mark Resolved</button>
                        <button class="btn btn-xs btn-secondary">Create Ticket</button>
                    ` : '<span style="color:var(--success);font-size:12px;">Resolved</span>'}
                </div>
            </div>
        `;
    }

    // ============== HELPERS ==============
    function getScoreColor(score) {
        if (!score) return 'var(--text-muted)';
        if (score >= 90) return 'var(--success)';
        if (score >= 70) return 'var(--warning)';
        return 'var(--error)';
    }

    // ============== ACTIONS ==============
    function switchTab(tab) {
        Store.setState({ currentTab: tab });
        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
        document.querySelector(`.main-tab[data-tab="${tab}"]`)?.classList.add('active');
        document.querySelector(`.nav-icon[data-tab="${tab}"]`)?.classList.add('active');
        render();
    }

    function setFilter(key, value) {
        Store.setState({ filters: { ...Store.getState().filters, [key]: value } });
        render();
    }

    function toggleCategory(id) {
        document.getElementById(`cat-${id}`).classList.toggle('open');
    }

    function openModal(type) {
        document.getElementById(`${type}Modal`).classList.add('active');
    }

    function closeModal(type) {
        document.getElementById(`${type}Modal`).classList.remove('active');
    }

    async function submitNewScan() {
        const form = document.getElementById('newScanForm');
        const url = form.url.value;
        const scanType = form.scanType.value;

        try {
            await api.post('/security/scan', { url, scan_type: scanType });
            showToast('Security scan started', 'success');
            closeModal('newScan');
            form.reset();
            fetchAllData();
        } catch (e) {
            showToast('Failed to start scan: ' + e.message, 'error');
        }
    }

    function resolveRec(id) {
        const { recommendations } = Store.getState();
        const updated = recommendations.map(r => r.id === id ? { ...r, resolved: true } : r);
        Store.setState({ recommendations: updated });
        render();
        showToast('Recommendation marked as resolved', 'success');
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span style="font-size:16px;">${type === 'success' ? 'C' : type === 'error' ? 'X' : 'i'}</span><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function exportReport() {
        showToast('Report export started...', 'info');
    }

    function exportRecs() {
        showToast('Recommendations exported', 'success');
    }

    function detectJourneys() {
        showToast('Journey detection started...', 'info');
    }

    function runJourney(id) {
        showToast('Running journey tests...', 'info');
    }

    function respondToClarification(id, response) {
        showToast(`Response recorded: ${response}`, 'success');
    }

    function filterChecks(query) {
        // Simple filter implementation
        console.log('Filtering:', query);
    }

    // ============== RENDER ==============
    function render() {
        const { currentTab, loading } = Store.getState();

        if (loading) {
            document.getElementById('tabContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            return;
        }

        const views = {
            overview: renderOverview,
            security: renderSecurity,
            journeys: renderJourneys,
            recommendations: renderRecommendations
        };

        document.getElementById('tabContent').innerHTML = views[currentTab]?.() || renderOverview();
    }

    // ============== FTUE COACH MARKS ==============
    const FTUE_STEPS = [
        {
            target: '.logo',
            title: 'Your Dashboard Home',
            text: 'Click the NEXUS logo anytime to return to the overview and see your overall security posture.',
            position: 'right',
            arrow: 'left'
        },
        {
            target: '.nav-icon[data-tab="overview"]',
            title: 'Overview Tab',
            text: 'Get a bird\'s eye view of your health score, security score, test coverage, and recent activity.',
            position: 'right',
            arrow: 'left'
        },
        {
            target: '.nav-icon[data-tab="security"]',
            title: 'Security & VAPT',
            text: 'Dive deep into 82+ security checks across 8 categories including OWASP, injection, authentication, and more.',
            position: 'right',
            arrow: 'left'
        },
        {
            target: '.nav-icon[data-tab="journeys"]',
            title: 'Feature Journeys',
            text: 'View auto-detected user journeys like login, checkout, and profile management. Run journey-specific tests.',
            position: 'right',
            arrow: 'left'
        },
        {
            target: '.nav-icon[data-tab="recommendations"]',
            title: 'Smart Recommendations',
            text: 'Get AI-prioritized fixes (P0/P1/P2) with compliance mapping. Mark issues resolved as you fix them.',
            position: 'right',
            arrow: 'left'
        },
        {
            target: '.btn-primary',
            title: 'Start Your First Scan',
            text: 'Click here to scan any URL! We\'ll run 82 security checks and generate actionable recommendations.',
            position: 'bottom',
            arrow: 'top'
        }
    ];

    let ftueCurrentStep = 0;
    let ftueActive = false;

    function checkFTUE() {
        const urlParams = new URLSearchParams(window.location.search);
        const isWelcome = urlParams.get('welcome') === 'true';
        const hasSeenFTUE = localStorage.getItem('nexus_ftue_completed');
        const userName = urlParams.get('name');

        if (isWelcome && !hasSeenFTUE) {
            // Personalize welcome message
            if (userName) {
                document.getElementById('ftueWelcomeText').innerHTML =
                    `Hey <strong>${decodeURIComponent(userName)}</strong>! We're excited to have you here. Let us show you around the platform so you can start securing your applications in minutes.`;
            }
            showFTUEWelcome();
        }
    }

    function showFTUEWelcome() {
        document.getElementById('ftueOverlay').classList.add('active');
        document.getElementById('ftueWelcome').classList.add('active');
    }

    function startFTUETour() {
        ftueActive = true;
        ftueCurrentStep = 0;
        document.getElementById('ftueWelcome').classList.remove('active');
        showFTUEStep(0);
    }

    function showFTUEStep(stepIndex) {
        const step = FTUE_STEPS[stepIndex];
        if (!step) {
            completeFTUE();
            return;
        }

        const target = document.querySelector(step.target);
        if (!target) {
            nextFTUEStep();
            return;
        }

        // Update step indicators
        const indicatorHTML = FTUE_STEPS.map((_, i) =>
            `<div class="ftue-step-dot ${i < stepIndex ? 'completed' : ''} ${i === stepIndex ? 'active' : ''}"></div>`
        ).join('');
        document.getElementById('ftueStepIndicator').innerHTML = indicatorHTML;

        // Update tooltip content
        document.getElementById('ftueTooltipTitle').textContent = step.title;
        document.getElementById('ftueTooltipText').textContent = step.text;

        // Show/hide back button
        document.getElementById('ftuePrevBtn').style.display = stepIndex > 0 ? 'inline-block' : 'none';

        // Update next button text
        const nextBtn = document.querySelector('.ftue-tooltip-btn.next');
        nextBtn.textContent = stepIndex === FTUE_STEPS.length - 1 ? 'Finish' : 'Next';

        // Position spotlight
        const rect = target.getBoundingClientRect();
        const spotlight = document.getElementById('ftueSpotlight');
        const ring = document.getElementById('ftueSpotlightRing');
        const padding = 8;

        spotlight.style.left = (rect.left - padding) + 'px';
        spotlight.style.top = (rect.top - padding) + 'px';
        ring.style.width = (rect.width + padding * 2) + 'px';
        ring.style.height = (rect.height + padding * 2) + 'px';
        spotlight.style.opacity = '1';

        // Position tooltip
        const tooltip = document.getElementById('ftueTooltip');
        tooltip.className = 'ftue-tooltip active arrow-' + step.arrow;

        if (step.position === 'right') {
            tooltip.style.left = (rect.right + 20) + 'px';
            tooltip.style.top = rect.top + 'px';
        } else if (step.position === 'bottom') {
            tooltip.style.left = Math.max(20, rect.left - 100) + 'px';
            tooltip.style.top = (rect.bottom + 20) + 'px';
        } else if (step.position === 'top') {
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 160) + 'px';
        }

        // Add highlight class to target
        document.querySelectorAll('.ftue-highlight').forEach(el => el.classList.remove('ftue-highlight'));
        target.classList.add('ftue-highlight');
    }

    function nextFTUEStep() {
        ftueCurrentStep++;
        if (ftueCurrentStep >= FTUE_STEPS.length) {
            completeFTUE();
        } else {
            showFTUEStep(ftueCurrentStep);
        }
    }

    function prevFTUEStep() {
        if (ftueCurrentStep > 0) {
            ftueCurrentStep--;
            showFTUEStep(ftueCurrentStep);
        }
    }

    function skipFTUE() {
        localStorage.setItem('nexus_ftue_completed', 'true');
        hideFTUE();
        showToast('Tour skipped. Access help anytime from the menu!', 'info');
    }

    function completeFTUE() {
        localStorage.setItem('nexus_ftue_completed', 'true');
        hideFTUE();
        showConfetti();
        showToast('You\'re all set! Start by running your first security scan.', 'success');
    }

    function hideFTUE() {
        ftueActive = false;
        document.getElementById('ftueOverlay').classList.remove('active');
        document.getElementById('ftueWelcome').classList.remove('active');
        document.getElementById('ftueTooltip').classList.remove('active');
        document.getElementById('ftueSpotlight').style.opacity = '0';
        document.querySelectorAll('.ftue-highlight').forEach(el => el.classList.remove('ftue-highlight'));

        // Clean up URL
        const url = new URL(window.location);
        url.searchParams.delete('welcome');
        url.searchParams.delete('name');
        url.searchParams.delete('email');
        window.history.replaceState({}, '', url);
    }

    function showConfetti() {
        const container = document.getElementById('ftueConfetti');
        const colors = ['#00ff88', '#00d4ff', '#a855f7', '#ffa502', '#ff4757'];

        for (let i = 0; i < 100; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + '%';
            piece.style.background = colors[Math.floor(Math.random() * colors.length)];
            piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            piece.style.width = (Math.random() * 10 + 5) + 'px';
            piece.style.height = (Math.random() * 10 + 5) + 'px';
            container.appendChild(piece);

            // Animate each piece
            const duration = Math.random() * 2 + 1;
            const delay = Math.random() * 0.5;
            piece.style.animation = `confettiFall ${duration}s ease-out ${delay}s forwards`;
        }

        // Add confetti animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
                100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Clean up after animation
        setTimeout(() => {
            container.innerHTML = '';
        }, 4000);
    }

    // ============== INIT ==============
    async function init() {
        // Set up tab navigation
        document.querySelectorAll('.main-tab, .nav-icon[data-tab]').forEach(el => {
            el.addEventListener('click', () => {
                if (el.dataset.tab) switchTab(el.dataset.tab);
            });
        });

        // Scan type toggle
        document.querySelector('select[name="scanType"]')?.addEventListener('change', (e) => {
            document.getElementById('categorySelector').style.display = e.target.value === 'custom' ? 'block' : 'none';
        });

        // Initial data fetch
        await fetchAllData();
        render();

        // Check for FTUE (First Time User Experience)
        setTimeout(checkFTUE, 500);

        // Auto-refresh
        setInterval(fetchAllData, 30000);
    }

    init();
    </script>
</body>
</html>
