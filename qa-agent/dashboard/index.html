<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://app.vibesecurity.in;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <title>NEXUS QA - Security Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #09090b;
            --bg-surface: #111113;
            --bg-elevated: #18181b;
            --bg-hover: #1f1f23;
            --border: #27272a;
            --border-hover: #3f3f46;
            --text: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --agent-idle: #71717a;
            --agent-running: #6366f1;
            --agent-complete: #22c55e;
            --agent-blocked: #f59e0b;
            --terminal-bg: #0d1117;
            --terminal-text: #c9d1d9;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-base);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        .logo-text span { color: var(--text-muted); font-weight: 400; }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--agent-idle);
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* Scan Input Section */
        .scan-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
        }

        .scan-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .scan-subtitle { color: var(--text-secondary); margin-bottom: 24px; }

        .scan-form { display: flex; gap: 12px; }

        .scan-input {
            flex: 1;
            background: var(--bg-base);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 18px;
            font-size: 15px;
            color: var(--text);
            outline: none;
            transition: var(--transition);
        }

        .scan-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--bg-hover); }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 8px 12px;
        }
        .btn-ghost:hover { color: var(--text); background: var(--bg-elevated); }

        /* Past Scans */
        .past-scans {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title { font-size: 16px; font-weight: 500; }

        .scans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .scan-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .scan-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .scan-card-url {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scan-card-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .scan-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .scan-status.completed { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .scan-status.running { background: rgba(99, 102, 241, 0.2); color: var(--accent); }
        .scan-status.paused { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .scan-status.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Live Scan View */
        .live-scan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .live-scan-url {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
        }

        .live-scan-controls {
            display: flex;
            gap: 12px;
        }

        /* Phase Timeline */
        .phase-timeline {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline-elapsed {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--accent);
        }

        .timeline-phases {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .phase {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .phase-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
            z-index: 1;
        }

        .phase.complete .phase-indicator {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .phase.active .phase-indicator {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0); }
        }

        .phase-connector {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border);
        }

        .phase.complete .phase-connector { background: var(--success); }
        .phase:last-child .phase-connector { display: none; }

        .phase-label {
            margin-top: 12px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .phase.active .phase-label { color: var(--text); }

        /* Main Grid */
        .scan-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .scan-grid { grid-template-columns: 1fr; }
        }

        /* Panels */
        .panel {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-badge {
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        .panel-body { padding: 16px 20px; }

        /* Interactive Chat Panel */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .chat-message.system {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            align-self: flex-start;
        }

        .chat-message.user {
            background: var(--accent);
            color: white;
            align-self: flex-end;
        }

        .chat-message.question {
            background: var(--warning);
            color: #000;
            align-self: flex-start;
        }

        .chat-message.question .options {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-option {
            background: rgba(255,255,255,0.9);
            color: #000;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: none;
            text-align: left;
            font-size: 13px;
            transition: var(--transition);
        }

        .chat-option:hover { background: white; }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-base);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus { border-color: var(--accent); }

        /* Terminal */
        .terminal {
            background: var(--terminal-bg);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            padding: 16px;
        }

        .terminal-line {
            display: flex;
            gap: 12px;
            margin-bottom: 4px;
        }

        .terminal-time { color: var(--text-muted); }
        .terminal-text { color: var(--terminal-text); }
        .terminal-text.success { color: var(--success); }
        .terminal-text.warning { color: var(--warning); }
        .terminal-text.error { color: var(--error); }

        /* API List */
        .api-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .api-row {
            display: grid;
            grid-template-columns: 60px 1fr 50px 60px;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            align-items: center;
        }

        .api-method {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
        }

        .api-method.get { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .api-method.post { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .api-method.put { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .api-method.delete { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        .api-path {
            font-family: var(--font-mono);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .api-status { font-family: var(--font-mono); }
        .api-status.s2xx { color: var(--success); }
        .api-status.s4xx { color: var(--warning); }
        .api-status.s5xx { color: var(--error); }

        /* Results View */
        .results-header {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .results-icon { font-size: 48px; margin-bottom: 16px; }
        .results-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .results-subtitle { color: var(--text-secondary); margin-bottom: 24px; }

        .results-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .score-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            margin: 32px 0;
        }

        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--success) calc(var(--score) * 1%), var(--bg-elevated) 0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 110px;
            height: 110px;
            background: var(--bg-surface);
            border-radius: 50%;
        }

        .score-value {
            position: relative;
            font-size: 36px;
            font-weight: 700;
        }

        .score-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .score-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .score-stat-value { font-size: 24px; font-weight: 600; }
        .score-stat-value.critical { color: var(--error); }
        .score-stat-value.high { color: var(--warning); }
        .score-stat-value.medium { color: #eab308; }
        .score-stat-value.low { color: var(--info); }

        .score-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Findings Section */
        .findings-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .finding-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .finding-card.critical { border-left: 4px solid var(--error); }
        .finding-card.high { border-left: 4px solid var(--warning); }
        .finding-card.medium { border-left: 4px solid #eab308; }
        .finding-card.low { border-left: 4px solid var(--info); }

        .finding-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .finding-severity {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .finding-severity.critical { background: var(--error); color: white; }
        .finding-severity.high { background: var(--warning); color: #000; }
        .finding-severity.medium { background: #eab308; color: #000; }
        .finding-severity.low { background: var(--info); color: white; }

        .finding-title { font-weight: 500; }

        .finding-details {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .finding-evidence {
            background: var(--terminal-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--terminal-text);
            margin-bottom: 12px;
        }

        .finding-action {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .finding-action-title {
            color: var(--success);
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* API Analysis Section */
        .api-analysis {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .api-analysis-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .api-analysis-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .api-io-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .api-io-box {
            background: var(--terminal-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
        }

        .api-io-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .api-io-content {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--terminal-text);
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
        }

        .api-issues {
            margin-top: 12px;
            padding: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
        }

        .api-issue-title {
            color: var(--error);
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .api-issue-list {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================================
           DEEP SCAN - JOURNEY & MODULE DISCOVERY UI
           ============================================================ */

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-item {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            transition: var(--transition);
        }

        .stat-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            font-family: var(--font-mono);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Live Screenshot Gallery */
        .screenshot-gallery {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
        }

        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .gallery-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gallery-live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
        }

        .gallery-live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: live-pulse 2s ease infinite;
        }

        @keyframes live-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .screenshot-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .screenshot-card:hover {
            border-color: var(--accent);
            transform: scale(1.02);
        }

        .screenshot-card.new {
            animation: screenshot-appear 0.5s ease;
        }

        @keyframes screenshot-appear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .screenshot-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: var(--bg-base);
        }

        .screenshot-info {
            padding: 10px;
        }

        .screenshot-title {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .screenshot-meta {
            font-size: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Journey Cards */
        .journeys-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
        }

        .journeys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .journey-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: var(--transition);
        }

        .journey-card:hover {
            border-color: var(--accent);
        }

        .journey-card.in-progress {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .journey-card.completed {
            border-color: var(--success);
        }

        .journey-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .journey-name {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .journey-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .journey-status.discovered { background: rgba(99, 102, 241, 0.2); color: var(--accent); }
        .journey-status.in-progress { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .journey-status.completed { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .journey-status.failed { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        .journey-screenshot {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: var(--bg-base);
        }

        .journey-steps {
            padding: 12px 16px;
        }

        .journey-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .journey-step:last-child {
            border-bottom: none;
        }

        .step-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .step-number.completed {
            background: var(--success);
            color: white;
        }

        .step-number.current {
            background: var(--accent);
            color: white;
            animation: pulse 2s ease infinite;
        }

        .step-content {
            flex: 1;
        }

        .step-action {
            color: var(--text);
            margin-bottom: 2px;
        }

        .step-element {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 10px;
        }

        /* Modules Section */
        .modules-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
        }

        .modules-tree {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .module-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }

        .module-item:hover {
            border-color: var(--accent);
        }

        .module-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--accent-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .module-info {
            flex: 1;
        }

        .module-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .module-features {
            font-size: 11px;
            color: var(--text-muted);
        }

        .module-screenshot-thumb {
            width: 60px;
            height: 40px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-base);
        }

        /* Screenshot Modal */
        .screenshot-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 40px;
        }

        .screenshot-modal.active {
            display: flex;
        }

        .screenshot-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .screenshot-modal-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .screenshot-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .screenshot-modal-close:hover {
            opacity: 1;
        }

        .screenshot-modal-info {
            margin-top: 16px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Current Action Indicator */
        .current-action {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .action-details {
            flex: 1;
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .action-description {
            font-size: 13px;
            opacity: 0.9;
        }

        .action-progress {
            font-family: var(--font-mono);
            font-size: 14px;
            text-align: right;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main { padding: 16px; }
            .scan-form { flex-direction: column; }
            .timeline-phases { flex-wrap: wrap; gap: 16px; }
            .phase-connector { display: none; }
            .api-io-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="goHome()">
                <div class="logo-icon">NQ</div>
                <div class="logo-text">NEXUS <span>QA</span></div>
            </div>
            <div class="header-actions">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText" style="font-size: 13px; color: var(--text-secondary);">Disconnected</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- HOME VIEW -->
        <div class="view active" id="homeView">
            <section class="scan-section">
                <h1 class="scan-title">Security Assessment</h1>
                <p class="scan-subtitle">Enter a URL to start a comprehensive security scan with real-time visualization</p>
                <div class="scan-form">
                    <input type="url" class="scan-input" id="urlInput" placeholder="https://example.com" />
                    <button class="btn btn-primary" id="startScanBtn" onclick="startScan()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Start Scan
                    </button>
                </div>
            </section>

            <section class="past-scans">
                <div class="section-header">
                    <span class="section-title">Recent Scans</span>
                    <button class="btn btn-ghost" onclick="loadPastScans()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div class="scans-grid" id="scansGrid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </section>
        </div>

        <!-- LIVE SCAN VIEW -->
        <div class="view" id="scanView">
            <div class="live-scan-header">
                <div class="live-scan-url" id="scanUrl">https://example.com</div>
                <div class="live-scan-controls">
                    <button class="btn btn-secondary" onclick="minimizeScan()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        Minimize
                    </button>
                    <button class="btn btn-ghost" onclick="goHome()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        Home
                    </button>
                </div>
            </div>

            <!-- Current Action Indicator -->
            <div class="current-action" id="currentAction">
                <div class="action-spinner"></div>
                <div class="action-details">
                    <div class="action-title" id="actionTitle">Initializing Deep Scan</div>
                    <div class="action-description" id="actionDescription">Setting up browser and preparing security analysis...</div>
                </div>
                <div class="action-progress">
                    <span id="elapsedTime">00:00</span>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <div class="stat-value" id="statPages">0</div>
                    <div class="stat-label">Pages Visited</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statButtons">0</div>
                    <div class="stat-label">Buttons Clicked</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statForms">0</div>
                    <div class="stat-label">Forms Filled</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statAPIs">0</div>
                    <div class="stat-label">API Calls</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statScreenshots">0</div>
                    <div class="stat-label">Screenshots</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statJourneys">0</div>
                    <div class="stat-label">Journeys</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statModules">0</div>
                    <div class="stat-label">Modules Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statFindings">0</div>
                    <div class="stat-label">Findings</div>
                </div>
            </div>

            <!-- Phase Timeline -->
            <div class="phase-timeline">
                <div class="timeline-header">
                    <span class="timeline-title">Deep Scan Phases</span>
                    <span class="panel-badge" id="phaseProgress">Phase 1 of 7</span>
                </div>
                <div class="timeline-phases">
                    <div class="phase" data-phase="initialize">
                        <div class="phase-indicator">1</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Initialize</div>
                    </div>
                    <div class="phase" data-phase="reconnaissance">
                        <div class="phase-indicator">2</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Recon</div>
                    </div>
                    <div class="phase" data-phase="authentication">
                        <div class="phase-indicator">3</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Auth</div>
                    </div>
                    <div class="phase" data-phase="deep_exploration">
                        <div class="phase-indicator">4</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Explore</div>
                    </div>
                    <div class="phase" data-phase="journey_testing">
                        <div class="phase-indicator">5</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Journeys</div>
                    </div>
                    <div class="phase" data-phase="security_analysis">
                        <div class="phase-indicator">6</div>
                        <div class="phase-connector"></div>
                        <div class="phase-label">Security</div>
                    </div>
                    <div class="phase" data-phase="finalize">
                        <div class="phase-indicator">7</div>
                        <div class="phase-label">Report</div>
                    </div>
                </div>
            </div>

            <!-- Live Screenshot Gallery -->
            <div class="screenshot-gallery" id="screenshotGallery">
                <div class="gallery-header">
                    <div class="gallery-title">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Live Screenshot Feed
                    </div>
                    <div class="gallery-live-indicator">
                        <div class="gallery-live-dot"></div>
                        <span>LIVE</span>
                    </div>
                </div>
                <div class="screenshot-grid" id="screenshotGrid">
                    <div class="empty-state" style="grid-column: 1/-1; padding: 40px;">
                        Screenshots will appear here as the scan explores your application...
                    </div>
                </div>
            </div>

            <!-- Discovered Journeys -->
            <div class="journeys-section" id="journeysSection">
                <div class="section-header">
                    <div class="gallery-title">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Discovered User Journeys
                    </div>
                    <span class="panel-badge" id="journeyCount">0 journeys</span>
                </div>
                <div class="journeys-grid" id="journeysGrid">
                    <div class="empty-state" style="grid-column: 1/-1; padding: 40px;">
                        User journeys will be discovered and displayed here as the scan explores your application...
                    </div>
                </div>
            </div>

            <!-- Discovered Modules -->
            <div class="modules-section" id="modulesSection">
                <div class="section-header">
                    <div class="gallery-title">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        Application Modules & Features
                    </div>
                    <span class="panel-badge" id="moduleCount">0 modules</span>
                </div>
                <div class="modules-tree" id="modulesTree">
                    <div class="empty-state" style="padding: 40px;">
                        Application modules and features will be mapped here during deep exploration...
                    </div>
                </div>
            </div>

            <div class="scan-grid">
                <div class="left-column">
                    <!-- Terminal Panel -->
                    <div class="panel" style="margin-bottom: 24px;">
                        <div class="panel-header">
                            <span class="panel-title">Activity Log</span>
                            <span class="panel-badge" id="logCount">0</span>
                        </div>
                        <div class="panel-body">
                            <div class="terminal" id="terminal"></div>
                        </div>
                    </div>

                    <!-- API Panel -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">API Calls Captured</span>
                            <span class="panel-badge" id="apiCount">0</span>
                        </div>
                        <div class="panel-body">
                            <div class="api-list" id="apiList"></div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Chat Panel -->
                <div class="panel chat-panel">
                    <div class="panel-header">
                        <span class="panel-title">Scan Assistant</span>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            Deep scan initiated. I'm exploring your application systematically - this may take 30-60 minutes for enterprise apps. I'll ask questions if I need credentials or encounter interactive elements.
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type a response..." onkeypress="handleChatKeypress(event)" />
                        <button class="btn btn-primary" onclick="sendChatMessage()" style="padding: 10px 16px;">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screenshot Modal -->
        <div class="screenshot-modal" id="screenshotModal" onclick="closeScreenshotModal()">
            <div class="screenshot-modal-content" onclick="event.stopPropagation()">
                <button class="screenshot-modal-close" onclick="closeScreenshotModal()">&times;</button>
                <img src="" alt="Screenshot" class="screenshot-modal-img" id="modalImage">
                <div class="screenshot-modal-info" id="modalInfo"></div>
            </div>
        </div>

        <!-- RESULTS VIEW -->
        <div class="view" id="resultsView">
            <div class="results-header">
                <div class="results-icon">‚úÖ</div>
                <h2 class="results-title">Scan Complete</h2>
                <p class="results-subtitle" id="resultsSubtitle">Security assessment finished</p>
                <div class="results-actions">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Download Report
                    </button>
                    <button class="btn btn-secondary" onclick="goHome()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        New Scan
                    </button>
                </div>
            </div>

            <div class="score-display">
                <div class="score-circle" style="--score: 90;">
                    <span class="score-value" id="scoreValue">90</span>
                </div>
                <div class="score-stats">
                    <div class="score-stat">
                        <div class="score-stat-value critical" id="criticalCount">0</div>
                        <div class="score-stat-label">Critical</div>
                    </div>
                    <div class="score-stat">
                        <div class="score-stat-value high" id="highCount">0</div>
                        <div class="score-stat-label">High</div>
                    </div>
                    <div class="score-stat">
                        <div class="score-stat-value medium" id="mediumCount">0</div>
                        <div class="score-stat-label">Medium</div>
                    </div>
                    <div class="score-stat">
                        <div class="score-stat-value low" id="lowCount">0</div>
                        <div class="score-stat-label">Low</div>
                    </div>
                </div>
            </div>

            <!-- Findings with Actionables -->
            <div class="findings-section">
                <div class="section-header">
                    <span class="section-title">Security Findings & Actionables</span>
                </div>
                <div id="findingsList"></div>
            </div>

            <!-- API Analysis -->
            <div class="api-analysis">
                <div class="section-header">
                    <span class="section-title">API Analysis - Input/Output Review</span>
                </div>
                <div id="apiAnalysisList"></div>
            </div>
        </div>
    </main>

    <script>
        // ============================================================
        // STATE MANAGEMENT
        // ============================================================
        const state = {
            currentView: 'home',
            scanId: null,
            eventSource: null,
            startTime: null,
            elapsedInterval: null,
            currentPhase: null,
            currentPhaseIndex: 0,
            logs: [],
            apiCalls: [],
            findings: [],
            chatMessages: [],
            awaitingResponse: false,
            pendingQuestion: null,
            // Deep scan state
            screenshots: [],
            journeys: {},
            modules: {},
            stats: {
                pages_visited: 0,
                buttons_clicked: 0,
                forms_filled: 0,
                api_calls_captured: 0,
                screenshots_taken: 0,
                journeys_completed: 0,
                modules_discovered: 0,
                elements_explored: 0,
                findings_count: 0
            }
        };

        // Phase mapping for deep scan (7 phases)
        const phases = ['initialize', 'reconnaissance', 'authentication', 'deep_exploration', 'journey_testing', 'security_analysis', 'finalize'];
        const phaseNames = {
            'initialize': 'Initializing Browser',
            'reconnaissance': 'Initial Reconnaissance',
            'authentication': 'Authentication Handling',
            'deep_exploration': 'Deep Exploration',
            'journey_testing': 'Testing User Journeys',
            'security_analysis': 'Security Analysis',
            'finalize': 'Generating Report'
        };

        // Legacy phase mapping for backward compatibility
        const phaseMap = {
            'browser_launch': 'initialize',
            'navigation': 'reconnaissance',
            'vlm_analysis': 'reconnaissance',
            'journey_exploration': 'deep_exploration',
            'security_checks': 'security_analysis',
            'reporting': 'finalize'
        };

        // ============================================================
        // VIEW MANAGEMENT
        // ============================================================
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            state.currentView = viewName;
        }

        function goHome() {
            // Clean up any running scan
            if (state.eventSource) {
                state.eventSource.close();
                state.eventSource = null;
            }
            if (state.elapsedInterval) {
                clearInterval(state.elapsedInterval);
                state.elapsedInterval = null;
            }

            // Reset UI
            resetScanUI();
            showView('home');
            loadPastScans();
        }

        function resetScanUI() {
            // Reset phase indicators
            document.querySelectorAll('.phase').forEach((p, i) => {
                p.classList.remove('active', 'complete');
                p.querySelector('.phase-indicator').textContent = (i + 1).toString();
            });

            // Reset main panels
            document.getElementById('terminal').innerHTML = '';
            document.getElementById('apiList').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = '<div class="chat-message system">Deep scan initiated. I\'m exploring your application systematically - this may take 30-60 minutes for enterprise apps. I\'ll ask questions if I need credentials or encounter interactive elements.</div>';
            document.getElementById('logCount').textContent = '0';
            document.getElementById('apiCount').textContent = '0';
            document.getElementById('elapsedTime').textContent = '00:00';
            document.getElementById('phaseProgress').textContent = 'Phase 1 of 7';

            // Reset stats
            document.getElementById('statPages').textContent = '0';
            document.getElementById('statButtons').textContent = '0';
            document.getElementById('statForms').textContent = '0';
            document.getElementById('statAPIs').textContent = '0';
            document.getElementById('statScreenshots').textContent = '0';
            document.getElementById('statJourneys').textContent = '0';
            document.getElementById('statModules').textContent = '0';
            document.getElementById('statFindings').textContent = '0';

            // Reset screenshot gallery
            document.getElementById('screenshotGrid').innerHTML = '<div class="empty-state" style="grid-column: 1/-1; padding: 40px;">Screenshots will appear here as the scan explores your application...</div>';

            // Reset journeys
            document.getElementById('journeysGrid').innerHTML = '<div class="empty-state" style="grid-column: 1/-1; padding: 40px;">User journeys will be discovered and displayed here as the scan explores your application...</div>';
            document.getElementById('journeyCount').textContent = '0 journeys';

            // Reset modules
            document.getElementById('modulesTree').innerHTML = '<div class="empty-state" style="padding: 40px;">Application modules and features will be mapped here during deep exploration...</div>';
            document.getElementById('moduleCount').textContent = '0 modules';

            // Reset current action
            document.getElementById('actionTitle').textContent = 'Initializing Deep Scan';
            document.getElementById('actionDescription').textContent = 'Setting up browser and preparing security analysis...';

            // Reset state
            state.logs = [];
            state.apiCalls = [];
            state.findings = [];
            state.chatMessages = [];
            state.screenshots = [];
            state.journeys = {};
            state.modules = {};
            state.currentPhase = null;
            state.currentPhaseIndex = 0;
            state.stats = {
                pages_visited: 0,
                buttons_clicked: 0,
                forms_filled: 0,
                api_calls_captured: 0,
                screenshots_taken: 0,
                journeys_completed: 0,
                modules_discovered: 0,
                elements_explored: 0,
                findings_count: 0
            };
        }

        // ============================================================
        // PAST SCANS
        // ============================================================
        async function loadPastScans() {
            const grid = document.getElementById('scansGrid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/live/scans');
                const data = await response.json();

                if (!data.scans || data.scans.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No previous scans. Start your first scan above!</div>';
                    return;
                }

                // Sort by most recent
                const scans = data.scans.sort((a, b) => new Date(b.started_at) - new Date(a.started_at));

                grid.innerHTML = scans.map(scan => `
                    <div class="scan-card" onclick="viewScan('${scan.scan_id}', '${scan.status}')">
                        <div class="scan-card-url">${escapeHtml(scan.url)}</div>
                        <div class="scan-card-meta">
                            <span class="scan-status ${scan.status}">${scan.status}</span>
                            <span>${formatTime(scan.started_at)}</span>
                            <span>${scan.findings_count || 0} findings</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load scans:', e);
                grid.innerHTML = '<div class="empty-state">Failed to load scans. Please refresh.</div>';
            }
        }

        async function viewScan(scanId, status) {
            if (status === 'running' || status === 'initializing') {
                // Resume watching the scan
                state.scanId = scanId;
                showView('scan');
                connectToScan(scanId);
            } else {
                // View completed scan results
                await loadScanResults(scanId);
            }
        }

        async function loadScanResults(scanId) {
            try {
                const response = await fetch(`/live/scan/${scanId}`);
                const data = await response.json();

                state.scanId = scanId;
                state.findings = data.findings || [];
                state.apiCalls = data.api_calls || [];

                // Calculate score
                const severityScores = { critical: 25, high: 15, medium: 8, low: 3 };
                const deduction = state.findings.reduce((acc, f) => acc + (severityScores[f.severity] || 0), 0);
                const score = Math.max(0, 100 - deduction);

                // Update UI
                document.getElementById('scoreValue').textContent = score;
                document.querySelector('.score-circle').style.setProperty('--score', score);

                document.getElementById('criticalCount').textContent = state.findings.filter(f => f.severity === 'critical').length;
                document.getElementById('highCount').textContent = state.findings.filter(f => f.severity === 'high').length;
                document.getElementById('mediumCount').textContent = state.findings.filter(f => f.severity === 'medium').length;
                document.getElementById('lowCount').textContent = state.findings.filter(f => f.severity === 'low').length;

                document.getElementById('resultsSubtitle').textContent = `Scan ${scanId} - ${data.url}`;

                renderFindings();
                renderApiAnalysis();

                showView('results');
            } catch (e) {
                console.error('Failed to load scan:', e);
                alert('Failed to load scan results');
            }
        }

        // ============================================================
        // START SCAN
        // ============================================================
        async function startScan() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            const btn = document.getElementById('startScanBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Starting...';

            try {
                const response = await fetch('/live/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();
                state.scanId = data.scan_id;

                document.getElementById('scanUrl').textContent = url;
                resetScanUI();
                showView('scan');

                // Start timer
                state.startTime = Date.now();
                state.elapsedInterval = setInterval(updateElapsedTime, 1000);

                // Connect to SSE
                connectToScan(data.scan_id);

            } catch (e) {
                console.error('Failed to start scan:', e);
                alert('Failed to start scan');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Start Scan';
            }
        }

        function connectToScan(scanId) {
            if (state.eventSource) {
                state.eventSource.close();
            }

            updateConnectionStatus('connecting');

            state.eventSource = new EventSource(`/live/scan/${scanId}/stream`);

            state.eventSource.onopen = () => {
                updateConnectionStatus('connected');
            };

            state.eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleScanEvent(data);
                } catch (e) {
                    console.error('Failed to parse event:', e);
                }
            };

            state.eventSource.onerror = () => {
                updateConnectionStatus('error');
                setTimeout(() => {
                    if (state.scanId && state.currentView === 'scan') {
                        connectToScan(state.scanId);
                    }
                }, 3000);
            };
        }

        // ============================================================
        // SCAN EVENTS
        // ============================================================
        function handleScanEvent(event) {
            console.log('Event:', event.type, event);

            // Add to terminal (except for frequent updates)
            if (!['stats_update', 'screenshot_captured'].includes(event.type)) {
                addLog(event.message, event.type);
            }

            switch (event.type) {
                case 'scan_started':
                    updatePhase('initialize', 'active');
                    updateCurrentAction('Initializing Deep Scan', 'Setting up headless browser and preparing security analysis...');
                    break;

                case 'phase_changed':
                    const rawPhase = event.data?.phase;
                    const phase = phaseMap[rawPhase] || rawPhase;
                    if (state.currentPhase && state.currentPhase !== phase) {
                        updatePhase(state.currentPhase, 'complete');
                    }
                    state.currentPhase = phase;
                    state.currentPhaseIndex = phases.indexOf(phase);
                    updatePhase(phase, 'active');
                    document.getElementById('phaseProgress').textContent = `Phase ${state.currentPhaseIndex + 1} of 7`;
                    updateCurrentAction(phaseNames[phase] || phase, event.message || 'Processing...');
                    break;

                case 'action_update':
                    // Real-time action updates
                    updateCurrentAction(event.data?.title || 'Processing', event.message || event.data?.description || '');
                    break;

                case 'stats_update':
                    // Update statistics
                    updateStats(event.data);
                    break;

                case 'screenshot_captured':
                    // Add screenshot to gallery - pass full event since image_base64 is at root level
                    addScreenshot(event);
                    break;

                // AI Planning Events
                case 'plan_started':
                    updateCurrentAction('AI Planning', event.message || 'Creating comprehensive test plan...');
                    addLog(event.message, 'plan');
                    break;

                case 'plan_note':
                    addLog(`üìù ${event.message}`, 'plan');
                    break;

                case 'plan_complete':
                    updateCurrentAction('Plan Ready', event.message || 'Test plan created');
                    addLog(`‚úÖ ${event.message}`, 'plan');
                    break;

                // AI Exploration Events
                case 'page_analyzed':
                    updateCurrentAction('AI Analysis', event.data?.analysis?.page_description || event.message || 'Analyzing page...');
                    if (event.image_base64) {
                        addScreenshot(event);
                    }
                    break;

                case 'action_decided':
                    updateCurrentAction('AI Decision', event.message || 'Deciding next action...');
                    addLog(`ü§ñ ${event.message}`, 'ai');
                    break;

                case 'action_executed':
                    state.stats.buttons_clicked++;
                    document.getElementById('statButtons').textContent = state.stats.buttons_clicked;
                    updateCurrentAction('Action Executed', event.message || 'Executing action...');
                    if (event.image_base64) {
                        addScreenshot(event);
                    }
                    break;

                case 'feature_discovered':
                    addLog(`üîç ${event.message}`, 'discovery');
                    break;

                // API Events
                case 'api_discovered':
                    addApiCall(event.data);
                    state.stats.api_calls_captured++;
                    document.getElementById('statAPIs').textContent = state.stats.api_calls_captured;
                    break;

                case 'api_analyzed':
                    updateCurrentAction('API Analysis', event.message || 'Analyzing API endpoint...');
                    break;

                // Security Testing Events
                case 'security_test_started':
                    updateCurrentAction('Security Testing', event.message || 'Running security tests...');
                    break;

                case 'vulnerability_found':
                    state.findings.push(event.data);
                    state.stats.findings_count++;
                    document.getElementById('statFindings').textContent = state.stats.findings_count;
                    addLog(`üö® ${event.message}`, 'vulnerability');
                    break;

                // Context and AI Events
                case 'context_note':
                    addLog(`‚ÑπÔ∏è ${event.message}`, 'info');
                    break;

                case 'ai_analysis':
                    addLog(`üß† AI: ${event.message}`, 'ai');
                    break;

                // Auth Events
                case 'login_attempted':
                    updateCurrentAction('Authenticating', event.message || 'Attempting login...');
                    break;

                case 'login_success':
                    updateCurrentAction('Authenticated', 'Successfully logged in');
                    addLog('‚úÖ Login successful', 'success');
                    break;

                case 'login_failed':
                    updateCurrentAction('Login Failed', event.message || 'Continuing with unauthenticated scan');
                    addLog('‚ö†Ô∏è Login failed - continuing unauthenticated', 'warning');
                    break;

                case 'journey_discovered':
                    // Add new journey card
                    addJourney(event.data);
                    break;

                case 'journey_step_completed':
                    // Update journey with new step
                    updateJourneyStep(event.data);
                    break;

                case 'journey_completed':
                    // Mark journey as complete
                    completeJourney(event.data);
                    break;

                case 'module_discovered':
                    // Add new module to tree
                    addModule(event.data);
                    break;

                case 'api_call_detected':
                    addApiCall(event.data);
                    state.stats.api_calls_captured++;
                    document.getElementById('statAPIs').textContent = state.stats.api_calls_captured;
                    break;

                case 'login_required':
                    // Show credentials question in chat
                    updateCurrentAction('Authentication Required', 'Login form detected - awaiting credentials...');
                    askQuestion('Login form detected. Would you like to provide credentials to scan authenticated areas?', [
                        { label: 'Yes, enter credentials', action: 'show_credentials' },
                        { label: 'Skip login', action: 'skip_login' }
                    ]);
                    break;

                case 'finding_detected':
                    state.findings.push(event.data);
                    state.stats.findings_count++;
                    document.getElementById('statFindings').textContent = state.stats.findings_count;
                    break;

                case 'scan_complete':
                    handleScanComplete(event.data);
                    break;

                case 'scan_error':
                    addChatMessage('system', `Error: ${event.message}`);
                    updateCurrentAction('Error Encountered', event.message);
                    break;

                case 'element_clicked':
                    state.stats.buttons_clicked++;
                    document.getElementById('statButtons').textContent = state.stats.buttons_clicked;
                    break;

                case 'form_filled':
                    state.stats.forms_filled++;
                    document.getElementById('statForms').textContent = state.stats.forms_filled;
                    break;

                case 'page_visited':
                    state.stats.pages_visited++;
                    document.getElementById('statPages').textContent = state.stats.pages_visited;
                    break;
            }
        }

        // Update current action indicator
        function updateCurrentAction(title, description) {
            document.getElementById('actionTitle').textContent = title;
            document.getElementById('actionDescription').textContent = description;
        }

        // Update stats from backend
        function updateStats(data) {
            if (!data) return;
            Object.keys(data).forEach(key => {
                if (state.stats.hasOwnProperty(key)) {
                    state.stats[key] = data[key];
                }
            });
            // Update UI
            document.getElementById('statPages').textContent = state.stats.pages_visited || 0;
            document.getElementById('statButtons').textContent = state.stats.buttons_clicked || 0;
            document.getElementById('statForms').textContent = state.stats.forms_filled || 0;
            document.getElementById('statAPIs').textContent = state.stats.api_calls_captured || 0;
            document.getElementById('statScreenshots').textContent = state.stats.screenshots_taken || 0;
            document.getElementById('statJourneys').textContent = state.stats.journeys_completed || 0;
            document.getElementById('statModules').textContent = state.stats.modules_discovered || 0;
            document.getElementById('statFindings').textContent = state.stats.findings_count || 0;
        }

        // Add screenshot to gallery
        function addScreenshot(eventOrData) {
            // Handle both full event object and legacy data-only format
            const imageBase64 = eventOrData.image_base64;
            const data = eventOrData.data || eventOrData;
            const title = data?.title || eventOrData.message || 'Screenshot';

            if (!imageBase64) return;

            const grid = document.getElementById('screenshotGrid');

            // Remove empty state if present
            const emptyState = grid.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const screenshotData = {
                image_base64: imageBase64,
                title: title,
                url: data?.url,
                journey_name: data?.journey_name,
                timestamp: eventOrData.timestamp || new Date().toISOString()
            };

            state.screenshots.unshift(screenshotData);
            state.stats.screenshots_taken++;
            document.getElementById('statScreenshots').textContent = state.stats.screenshots_taken;

            const card = document.createElement('div');
            card.className = 'screenshot-card new';
            card.onclick = () => openScreenshotModal(screenshotData);
            card.innerHTML = `
                <img src="data:image/png;base64,${imageBase64}" alt="${escapeHtml(title)}" class="screenshot-img">
                <div class="screenshot-info">
                    <div class="screenshot-title">${escapeHtml(title)}</div>
                    <div class="screenshot-meta">
                        <span>${screenshotData.journey_name || 'Exploration'}</span>
                        <span>${formatTimestamp(new Date())}</span>
                    </div>
                </div>
            `;

            grid.insertBefore(card, grid.firstChild);

            // Remove 'new' class after animation
            setTimeout(() => card.classList.remove('new'), 500);

            // Keep only last 50 screenshots in view
            while (grid.children.length > 50) {
                grid.removeChild(grid.lastChild);
            }
        }

        // Add journey card
        function addJourney(data) {
            if (!data || !data.id) return;

            const grid = document.getElementById('journeysGrid');

            // Remove empty state if present
            const emptyState = grid.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            state.journeys[data.id] = data;
            state.stats.modules_discovered++;
            document.getElementById('journeyCount').textContent = `${Object.keys(state.journeys).length} journeys`;

            const card = document.createElement('div');
            card.className = 'journey-card';
            card.id = `journey-${data.id}`;
            card.innerHTML = `
                <div class="journey-header">
                    <div class="journey-name">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        ${escapeHtml(data.name)}
                    </div>
                    <span class="journey-status discovered">Discovered</span>
                </div>
                ${data.screenshot_base64 ? `<img src="data:image/png;base64,${data.screenshot_base64}" class="journey-screenshot">` : '<div style="height:100px;background:var(--bg-base);display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:12px;">Awaiting screenshot...</div>'}
                <div class="journey-steps" id="journey-steps-${data.id}">
                    <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:8px;">
                        ${escapeHtml(data.description || 'Journey discovered - testing will begin shortly...')}
                    </div>
                </div>
            `;

            grid.insertBefore(card, grid.firstChild);
        }

        // Update journey with step progress
        function updateJourneyStep(data) {
            if (!data || !data.journey_id) return;

            const journey = state.journeys[data.journey_id];
            if (!journey) return;

            journey.steps = journey.steps || [];
            journey.steps.push(data.step);
            journey.status = 'in_progress';

            const card = document.getElementById(`journey-${data.journey_id}`);
            if (!card) return;

            // Update status badge
            const statusBadge = card.querySelector('.journey-status');
            if (statusBadge) {
                statusBadge.className = 'journey-status in-progress';
                statusBadge.textContent = 'In Progress';
            }

            // Update card class
            card.classList.add('in-progress');

            // Update steps list
            const stepsContainer = card.querySelector(`#journey-steps-${data.journey_id}`);
            if (stepsContainer) {
                // Clear placeholder if first step
                if (journey.steps.length === 1) {
                    stepsContainer.innerHTML = '';
                }

                const step = data.step;
                const stepEl = document.createElement('div');
                stepEl.className = 'journey-step';
                stepEl.innerHTML = `
                    <div class="step-number current">${journey.steps.length}</div>
                    <div class="step-content">
                        <div class="step-action">${escapeHtml(step.action || step.description)}</div>
                        ${step.element ? `<div class="step-element">${escapeHtml(step.element)}</div>` : ''}
                    </div>
                `;
                stepsContainer.appendChild(stepEl);
            }

            // Update screenshot if provided
            if (data.screenshot_base64) {
                const screenshotEl = card.querySelector('.journey-screenshot');
                if (screenshotEl) {
                    screenshotEl.src = `data:image/png;base64,${data.screenshot_base64}`;
                } else {
                    const placeholder = card.querySelector('.journey-header + div');
                    if (placeholder) {
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${data.screenshot_base64}`;
                        img.className = 'journey-screenshot';
                        placeholder.replaceWith(img);
                    }
                }
            }
        }

        // Mark journey as complete
        function completeJourney(data) {
            if (!data || !data.journey_id) return;

            const journey = state.journeys[data.journey_id];
            if (journey) {
                journey.status = 'completed';
            }

            state.stats.journeys_completed++;
            document.getElementById('statJourneys').textContent = state.stats.journeys_completed;

            const card = document.getElementById(`journey-${data.journey_id}`);
            if (!card) return;

            card.classList.remove('in-progress');
            card.classList.add('completed');

            const statusBadge = card.querySelector('.journey-status');
            if (statusBadge) {
                statusBadge.className = 'journey-status completed';
                statusBadge.textContent = 'Completed';
            }

            // Mark all steps as completed
            const stepNumbers = card.querySelectorAll('.step-number.current');
            stepNumbers.forEach(el => {
                el.classList.remove('current');
                el.classList.add('completed');
            });
        }

        // Add module to tree
        function addModule(data) {
            if (!data || !data.id) return;

            const tree = document.getElementById('modulesTree');

            // Remove empty state if present
            const emptyState = tree.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            state.modules[data.id] = data;
            state.stats.modules_discovered++;
            document.getElementById('statModules').textContent = state.stats.modules_discovered;
            document.getElementById('moduleCount').textContent = `${Object.keys(state.modules).length} modules`;

            const item = document.createElement('div');
            item.className = 'module-item';
            item.id = `module-${data.id}`;
            item.innerHTML = `
                <div class="module-icon">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                </div>
                <div class="module-info">
                    <div class="module-name">${escapeHtml(data.name)}</div>
                    <div class="module-features">${escapeHtml(data.description || (data.features && data.features.length ? data.features.slice(0, 3).join(', ') : 'Exploring features...'))}</div>
                </div>
                ${data.screenshot_base64 ? `<img src="data:image/png;base64,${data.screenshot_base64}" class="module-screenshot-thumb">` : ''}
            `;

            tree.appendChild(item);
        }

        // Screenshot modal functions
        function openScreenshotModal(data) {
            const modal = document.getElementById('screenshotModal');
            const img = document.getElementById('modalImage');
            const info = document.getElementById('modalInfo');

            img.src = `data:image/png;base64,${data.image_base64}`;
            info.innerHTML = `<strong>${escapeHtml(data.title || 'Screenshot')}</strong><br>${escapeHtml(data.journey_name || 'Exploration')} - ${escapeHtml(data.url || '')}`;

            modal.classList.add('active');
        }

        function closeScreenshotModal() {
            document.getElementById('screenshotModal').classList.remove('active');
        }

        function handleScanComplete(data) {
            if (state.eventSource) {
                state.eventSource.close();
            }
            if (state.elapsedInterval) {
                clearInterval(state.elapsedInterval);
            }

            updateConnectionStatus('disconnected');

            // Update current action
            updateCurrentAction('Scan Complete', 'Security assessment finished. Preparing results...');

            // Mark all phases complete
            document.querySelectorAll('.phase').forEach((p, i) => {
                p.classList.remove('active');
                p.classList.add('complete');
                p.querySelector('.phase-indicator').textContent = '‚úì';
            });
            document.getElementById('phaseProgress').textContent = 'Complete';

            // Add completion message to chat
            addChatMessage('system', `Deep scan completed! Discovered ${Object.keys(state.modules).length} modules, ${Object.keys(state.journeys).length} journeys, and ${state.findings.length} security findings.`);

            // Wait a moment then show results
            setTimeout(() => {
                loadScanResults(state.scanId);
            }, 2000);
        }

        // ============================================================
        // CHAT & INTERACTION
        // ============================================================
        function addChatMessage(type, text) {
            const messages = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = `chat-message ${type}`;
            msg.textContent = text;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function askQuestion(question, options) {
            state.awaitingResponse = true;
            state.pendingQuestion = { question, options };

            const messages = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message question';
            msg.innerHTML = `
                <strong>${question}</strong>
                <div class="options">
                    ${options.map(opt => `<button class="chat-option" onclick="handleOption('${opt.action}')">${opt.label}</button>`).join('')}
                </div>
            `;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        async function handleOption(action) {
            state.awaitingResponse = false;
            addChatMessage('user', action === 'skip_login' ? 'Skip login' : 'Enter credentials');

            if (action === 'skip_login') {
                await fetch(`/live/scan/${state.scanId}/skip-login`, { method: 'POST' });
                addChatMessage('system', 'Continuing scan without authentication...');
            } else if (action === 'show_credentials') {
                askCredentials();
            }
        }

        function askCredentials() {
            const messages = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message question';
            msg.innerHTML = `
                <strong>Enter login credentials:</strong>
                <div style="margin-top: 12px;">
                    <input type="text" id="credEmail" placeholder="Email / Username" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: none;">
                    <input type="password" id="credPassword" placeholder="Password" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: none;">
                    <button class="chat-option" onclick="submitCredentials()" style="width: 100%;">Continue Scan</button>
                </div>
            `;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        async function submitCredentials() {
            const email = document.getElementById('credEmail').value;
            const password = document.getElementById('credPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                await fetch(`/live/scan/${state.scanId}/credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                addChatMessage('user', 'Credentials provided');
                addChatMessage('system', 'Credentials submitted. Continuing with authenticated scan...');
            } catch (e) {
                addChatMessage('system', 'Failed to submit credentials. Continuing without authentication.');
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addChatMessage('user', text);
            input.value = '';

            // Handle text responses
            if (state.awaitingResponse) {
                state.awaitingResponse = false;
                addChatMessage('system', 'Response received. Continuing scan...');
            }
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        // ============================================================
        // TERMINAL & API
        // ============================================================
        function addLog(message, type = 'info') {
            state.logs.push({ message, type, time: new Date() });

            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = 'terminal-line';

            const severity = type.includes('error') ? 'error' : type.includes('finding') ? 'warning' : type.includes('complete') ? 'success' : '';

            line.innerHTML = `
                <span class="terminal-time">${formatTimestamp(new Date())}</span>
                <span class="terminal-text ${severity}">${escapeHtml(message)}</span>
            `;

            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
            document.getElementById('logCount').textContent = state.logs.length;
        }

        function addApiCall(data) {
            state.apiCalls.push(data);

            const list = document.getElementById('apiList');
            const method = (data.method || 'GET').toUpperCase();
            const status = data.response_status || 0;
            const statusClass = status >= 500 ? 's5xx' : status >= 400 ? 's4xx' : 's2xx';

            const row = document.createElement('div');
            row.className = 'api-row';
            row.innerHTML = `
                <span class="api-method ${method.toLowerCase()}">${method}</span>
                <span class="api-path" title="${escapeHtml(data.url)}">${escapeHtml(data.path || data.url)}</span>
                <span class="api-status ${statusClass}">${status}</span>
                <span style="color: var(--text-muted);">${data.duration_ms ? data.duration_ms + 'ms' : '-'}</span>
            `;

            list.appendChild(row);
            list.scrollTop = list.scrollHeight;
            document.getElementById('apiCount').textContent = state.apiCalls.length;
        }

        // ============================================================
        // RESULTS RENDERING
        // ============================================================
        function renderFindings() {
            const container = document.getElementById('findingsList');

            if (state.findings.length === 0) {
                container.innerHTML = '<div class="empty-state">No security issues found!</div>';
                return;
            }

            // Group by severity
            const grouped = { critical: [], high: [], medium: [], low: [] };
            state.findings.forEach(f => {
                const sev = (f.severity || 'low').toLowerCase();
                if (grouped[sev]) grouped[sev].push(f);
            });

            container.innerHTML = Object.entries(grouped)
                .filter(([_, items]) => items.length > 0)
                .map(([severity, items]) => items.map(f => `
                    <div class="finding-card ${severity}">
                        <div class="finding-header">
                            <span class="finding-severity ${severity}">${severity}</span>
                            <span class="finding-title">${escapeHtml(f.title || f.id)}</span>
                        </div>
                        <div class="finding-details">${escapeHtml(f.description || `Found at: ${f.url || 'N/A'}`)}</div>
                        <div class="finding-evidence">
                            <strong>Evidence:</strong> ${escapeHtml(f.evidence || 'No specific evidence captured')}
                        </div>
                        <div class="finding-action">
                            <div class="finding-action-title">Recommended Action:</div>
                            ${getRecommendation(f)}
                        </div>
                    </div>
                `).join('')).join('');
        }

        function getRecommendation(finding) {
            const recommendations = {
                'Missing X-Content-Type-Options': 'Add header: <code>X-Content-Type-Options: nosniff</code> to prevent MIME-type sniffing attacks.',
                'Missing X-Frame-Options': 'Add header: <code>X-Frame-Options: DENY</code> or <code>SAMEORIGIN</code> to prevent clickjacking.',
                'Missing Strict-Transport-Security': 'Add header: <code>Strict-Transport-Security: max-age=31536000; includeSubDomains</code> to enforce HTTPS.',
                'Missing Content-Security-Policy': 'Implement a Content Security Policy to prevent XSS and data injection attacks.',
                'Cookie Missing HttpOnly': 'Set <code>HttpOnly</code> flag on cookies to prevent JavaScript access.',
                'Cookie Missing Secure': 'Set <code>Secure</code> flag on cookies to ensure they\'re only sent over HTTPS.',
                'Cookie Missing SameSite': 'Set <code>SameSite=Strict</code> or <code>Lax</code> to prevent CSRF attacks.',
                'Not Using HTTPS': 'Migrate to HTTPS immediately. Obtain an SSL certificate and redirect all HTTP traffic.',
                'Password Field Allows Autocomplete': 'Add <code>autocomplete="off"</code> or <code>autocomplete="new-password"</code> to password fields.'
            };

            const title = finding.title || '';
            for (const [key, rec] of Object.entries(recommendations)) {
                if (title.includes(key)) return rec;
            }
            return finding.recommendation || 'Review and fix according to security best practices.';
        }

        function renderApiAnalysis() {
            const container = document.getElementById('apiAnalysisList');

            if (state.apiCalls.length === 0) {
                container.innerHTML = '<div class="empty-state">No API calls captured during scan.</div>';
                return;
            }

            // Analyze first 10 unique API calls
            const uniqueApis = [];
            const seen = new Set();
            for (const api of state.apiCalls) {
                const key = `${api.method}:${api.path}`;
                if (!seen.has(key) && uniqueApis.length < 10) {
                    seen.add(key);
                    uniqueApis.push(api);
                }
            }

            container.innerHTML = uniqueApis.map(api => {
                const issues = analyzeApiIssues(api);
                return `
                    <div class="api-analysis-card">
                        <div class="api-analysis-header">
                            <span class="api-method ${(api.method || 'get').toLowerCase()}">${(api.method || 'GET').toUpperCase()}</span>
                            <span style="font-family: var(--font-mono); font-size: 13px;">${escapeHtml(api.path || api.url)}</span>
                            <span class="api-status ${api.response_status >= 400 ? 's4xx' : 's2xx'}">${api.response_status}</span>
                        </div>
                        <div class="api-io-section">
                            <div class="api-io-box">
                                <div class="api-io-label">Request Headers</div>
                                <div class="api-io-content">${formatHeaders(api.request_headers)}</div>
                            </div>
                            <div class="api-io-box">
                                <div class="api-io-label">Response Headers</div>
                                <div class="api-io-content">${formatHeaders(api.response_headers)}</div>
                            </div>
                        </div>
                        ${issues.length > 0 ? `
                            <div class="api-issues">
                                <div class="api-issue-title">Security Issues Found:</div>
                                <div class="api-issue-list">
                                    ${issues.map(i => `<div>‚Ä¢ ${i}</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function analyzeApiIssues(api) {
            const issues = [];
            const headers = api.response_headers || {};
            const headersLower = Object.fromEntries(Object.entries(headers).map(([k, v]) => [k.toLowerCase(), v]));

            if (!headersLower['x-content-type-options']) issues.push('Missing X-Content-Type-Options header');
            if (!headersLower['x-frame-options']) issues.push('Missing X-Frame-Options header');
            if (!headersLower['strict-transport-security']) issues.push('Missing HSTS header');
            if (!headersLower['content-security-policy']) issues.push('Missing CSP header');
            if (headersLower['server']) issues.push(`Server version exposed: ${headersLower['server']}`);
            if (headersLower['x-powered-by']) issues.push(`Technology exposed: ${headersLower['x-powered-by']}`);

            return issues;
        }

        function formatHeaders(headers) {
            if (!headers || Object.keys(headers).length === 0) return 'No headers captured';
            return Object.entries(headers)
                .slice(0, 8)
                .map(([k, v]) => `${k}: ${v}`)
                .join('\n');
        }

        // ============================================================
        // DOWNLOAD REPORT
        // ============================================================
        async function downloadReport() {
            if (!state.scanId) return;

            try {
                const response = await fetch(`/live/scan/${state.scanId}/report`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `security_report_${state.scanId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Download failed:', e);
                // Fallback: generate client-side
                generateClientReport();
            }
        }

        function generateClientReport() {
            // Generate HTML report with full findings
            const html = `<!DOCTYPE html>
<html><head><title>Security Report - ${state.scanId}</title>
<style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px}
.finding{border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:8px}
.finding.critical{border-left:4px solid #ef4444}
.finding.high{border-left:4px solid #f59e0b}
.finding.medium{border-left:4px solid #eab308}
.finding.low{border-left:4px solid #3b82f6}
.action{background:#f0fdf4;border:1px solid #bbf7d0;padding:12px;margin-top:12px;border-radius:4px}</style></head>
<body><h1>Security Scan Report</h1>
<p><strong>Scan ID:</strong> ${state.scanId}</p>
<p><strong>Findings:</strong> ${state.findings.length}</p>
<h2>Findings</h2>
${state.findings.map(f => `<div class="finding ${f.severity}">
<strong>[${(f.severity || 'INFO').toUpperCase()}] ${f.title || f.id}</strong>
<p>${f.evidence || ''}</p>
<div class="action"><strong>Action:</strong> ${getRecommendation(f)}</div>
</div>`).join('')}
<h2>API Analysis</h2>
${state.apiCalls.slice(0, 10).map(api => `<div class="finding">
<strong>${api.method} ${api.path}</strong> - Status: ${api.response_status}
</div>`).join('')}
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_report_${state.scanId}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================================
        // UI HELPERS
        // ============================================================
        function updatePhase(phaseName, status) {
            const phase = document.querySelector(`.phase[data-phase="${phaseName}"]`);
            if (!phase) return;

            phase.classList.remove('active', 'complete');
            phase.classList.add(status);

            if (status === 'complete') {
                phase.querySelector('.phase-indicator').textContent = '‚úì';
            }
        }

        function updateElapsedTime() {
            if (!state.startTime) return;
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('elapsedTime').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');

            dot.classList.remove('connected');
            if (status === 'connected') {
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else if (status === 'connecting') {
                text.textContent = 'Connecting...';
            } else {
                text.textContent = 'Disconnected';
            }
        }

        function minimizeScan() {
            goHome();
            // The scan continues in background, can be resumed from past scans
        }

        function formatTime(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function formatTimestamp(date) {
            return date.toTimeString().slice(0, 8);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadPastScans();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close modal first
                const modal = document.getElementById('screenshotModal');
                if (modal.classList.contains('active')) {
                    closeScreenshotModal();
                    return;
                }
                // Then go home
                if (state.currentView !== 'home') {
                    goHome();
                }
            }
            if (e.key === 'Enter' && document.activeElement === document.getElementById('urlInput')) {
                startScan();
            }
        });

        // Animate stats on update
        function animateStat(element, newValue) {
            const currentValue = parseInt(element.textContent) || 0;
            if (newValue === currentValue) return;

            element.style.transform = 'scale(1.2)';
            element.style.color = 'var(--success)';
            element.textContent = newValue;

            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = 'var(--accent)';
            }, 200);
        }
    </script>
</body>
</html>
